<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="theme-color" content="#020810" />
  <title>Protocollo: Fauno</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { theme: { extend: {
      colors: { cyber: { bg: '#020810', card: '#080c18', cyan: '#00f0ff', pink: '#ff3366', gold: '#f9ca24', purple: '#7b2ff7', green: '#22c55e', orange: '#f97316' } },
      fontFamily: { mono: ['JetBrains Mono', 'SF Mono', 'monospace'], sans: ['Inter', 'system-ui', 'sans-serif'] },
    }}}
  </script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=JetBrains+Mono:wght@400;700&display=swap');
    * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
    body { margin: 0; background: #020810; overflow-x: hidden; }
    input[type="range"] { -webkit-appearance: none; height: 6px; background: rgba(255,255,255,0.08); border-radius: 3px; outline: none; }
    input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 22px; height: 22px; border-radius: 50%; background: #5cc8e6; cursor: pointer; box-shadow: 0 0 8px rgba(92,200,230,0.3); }
    textarea:focus, input:focus { outline: none; border-color: rgba(92,200,230,0.4) !important; box-shadow: 0 0 0 2px rgba(92,200,230,0.15); }
    /* Focus-visible for keyboard navigation */
    button:focus-visible, a:focus-visible, input:focus-visible, textarea:focus-visible {
      outline: 2px solid #5cc8e6; outline-offset: 2px;
    }
    /* Respect reduced motion */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after { animation-duration: 0.01ms !important; animation-iteration-count: 1 !important; transition-duration: 0.01ms !important; }
    }

    /* Cinematic Earth ‚Äî compact */
    .earth-container { position: relative; width: 100%; height: 30vh; min-height: 200px; display: flex; align-items: center; justify-content: center; overflow: hidden; }
    .earth-glow { position: absolute; width: 220px; height: 220px; border-radius: 50%;
      background: radial-gradient(circle at 35% 35%, #1a5a8a 0%, #0d3050 25%, #071e38 50%, #030e1c 75%, #010509 100%);
      box-shadow: 0 0 120px 40px rgba(0,120,255,0.08), 0 0 60px 20px rgba(0,180,255,0.05), inset -30px -15px 50px rgba(0,0,0,0.9), inset 8px 8px 30px rgba(80,160,255,0.06);
    }
    .earth-atmosphere { position: absolute; width: 240px; height: 240px; border-radius: 50%;
      background: radial-gradient(circle, transparent 45%, rgba(60,140,255,0.04) 55%, rgba(40,120,255,0.08) 65%, rgba(20,80,200,0.04) 80%, transparent 100%);
      box-shadow: 0 0 80px 30px rgba(0,100,255,0.04);
    }
    .earth-continents { position: absolute; width: 440px; height: 220px; border-radius: 50%;
      background:
        radial-gradient(ellipse 15% 22% at 18% 35%, rgba(30,110,70,0.5) 0%, transparent 100%),
        radial-gradient(ellipse 10% 15% at 23% 32%, rgba(35,120,65,0.4) 0%, transparent 100%),
        radial-gradient(ellipse 6% 5% at 32% 48%, rgba(40,130,70,0.35) 0%, transparent 100%),
        radial-gradient(ellipse 12% 10% at 50% 36%, rgba(38,125,68,0.45) 0%, transparent 100%),
        radial-gradient(ellipse 16% 16% at 53% 40%, rgba(33,115,60,0.35) 0%, transparent 100%),
        radial-gradient(ellipse 5% 7% at 65% 52%, rgba(36,120,65,0.4) 0%, transparent 100%),
        radial-gradient(ellipse 8% 11% at 75% 28%, rgba(30,110,58,0.35) 0%, transparent 100%),
        radial-gradient(ellipse 20% 6% at 40% 72%, rgba(255,255,255,0.08) 0%, transparent 100%);
    }
    .earth-clip { position: absolute; width: 220px; height: 220px; border-radius: 50%; overflow: hidden; }
    .earth-horizon { position: absolute; bottom: -20%; left: -10%; width: 120%; height: 50%;
      background: linear-gradient(to top, rgba(0,80,200,0.06), transparent);
    }

    @keyframes earth-rotate { from { transform: translateX(0); } to { transform: translateX(-220px); } }
    @keyframes float-slow { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-6px); } }
    @keyframes fade-in { from { opacity: 0; transform: translateY(16px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes pulse-soft { 0%, 100% { opacity: 0.6; } 50% { opacity: 1; } }
    .animate-earth { animation: earth-rotate 80s linear infinite; }
    .animate-float { animation: float-slow 6s ease-in-out infinite; }
    .animate-fade { animation: fade-in 1s ease-out; }
    .animate-fade-delay { animation: fade-in 1s ease-out 0.3s both; }
    .animate-fade-delay2 { animation: fade-in 1s ease-out 0.6s both; }
    .animate-fade-delay3 { animation: fade-in 1s ease-out 0.9s both; }
    .animate-pulse-soft { animation: pulse-soft 3s ease-in-out infinite; }

    /* ‚ïê‚ïê‚ïê RESPONSIVE ‚ïê‚ïê‚ïê */
    /* Mobile-first base */
    .resp-container { max-width: 32rem; margin: 0 auto; }

    /* Tablet (640px+) */
    @media (min-width: 640px) {
      .resp-container { max-width: 40rem; }
      .earth-container { height: 46vh; min-height: 300px; }
      .earth-glow { width: 280px; height: 280px; }
      .earth-atmosphere { width: 310px; height: 310px; }
      .earth-clip { width: 280px; height: 280px; }
      .earth-continents { width: 560px; height: 280px; }
    }

    /* Desktop (1024px+) */
    @media (min-width: 1024px) {
      .resp-container { max-width: 48rem; }
      .earth-container { height: 50vh; min-height: 360px; }
      .earth-glow { width: 320px; height: 320px; }
      .earth-atmosphere { width: 350px; height: 350px; }
      .earth-clip { width: 320px; height: 320px; }
      .earth-continents { width: 640px; height: 320px; }
    }

    /* Large desktop (1280px+) */
    @media (min-width: 1280px) {
      .resp-container { max-width: 56rem; }
    }
  </style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useCallback, useEffect, useRef } = React;

const STORAGE_KEY = 'eko-protocollo-fauno';

const DEFAULT_STATE = {
  fauno: {
    nome: "Fauno", livello: 1, classe: "Osservatore ¬∑ Creatore", titolo: "Il Risvegliato",
    hp: { c: 45, m: 100 },
    stats: { disciplina: 15, corpo: 20, mente: 65, spirito: 40, carisma: 50, resistenza: 30 },
    peso: { attuale: 85, obiettivo: 70, partenza: 85 },
    pesoLog: [], deadline: "2026-04-18",
  },
  eko: {
    livello: 1, xp: 0, xpMax: 100, titolo: "Eco Nascente",
    tratti: ["Curiosit√†", "Pianificazione", "UI/UX Review"],
    xpLog: [],
    personalita: { ironia: 7, tough_love: 6, creativita: 8 },
    questEko: [
      { id: "EQ001", n: "GitHub Deployment", d: "Platform live on GitHub Pages", s: "done", o: "auto", completedAt: "2026-02-17T00:00:00Z" },
      { id: "EQ002", n: "Telegram Mini App", d: "Integrare piattaforma come Web App dentro Telegram", s: "attesa", o: "auto" },
      { id: "EQ003", n: "Design System Sync", d: "Collegare Storybook UniversiData alla piattaforma", s: "attesa", o: "auto" },
      { id: "EQ004", n: "Analytics Engine", d: "Grafici trend peso e stats nel tempo", s: "attesa", o: "auto" },
      { id: "EQ005", n: "Journaling Module", d: "Sezione journaling con prompt mattina/sera", s: "attesa", o: "auto" },
      { id: "EQ006", n: "A-Frame nella Natura", d: "Piano di fuga: A-frame house nella natura.", s: "attesa", o: "auto" },
      { id: "EQ007", n: "Scheduler Engine", d: "Connect scheduler toggles to actual Telegram notifications via Railway bot", s: "attesa", o: "auto" },
      { id: "EQ008", n: "Personality Sync", d: "Sync personality sliders to Telegram Eko behavior", s: "attesa", o: "auto" },
      { id: "EQ009", n: "Migrate to Vite + React Router", d: "Proper multi-page React app with build step", s: "attesa", o: "auto" },
    ],
  },
  cristina: {
    dateImportanti: [{ data: "", evento: "Anniversario", nota: "" }, { data: "", evento: "Compleanno Cristina", nota: "" }],
    gestaRecenti: [], noteRelazione: [], moodCheck: null, ultimoGesto: null,
    promemoria: ["Hai ascoltato Cristina oggi?", "Quando √® stata l'ultima volta che l'hai sorpresa?", "Lei √® la priorit√†. Prima di UniversiData.", "Un piccolo gesto vale pi√π di mille promesse.", "Chiedile come sta. Ascolta davvero."],
    ciclo: { ultimoInizio: "", durataMedia: 28, durataMestruazione: 5, log: [] },
    eventiSpeciali: [],
  },
  universidata: { taskAttivi: [], scadenze: [], noteStrategiche: [], prioritaSettimana: "" },
  quests: [
    { id: 1, n: "Digiuno 16h", d: "Completa IF", xp: 15, t: "corpo", status: "available", i: "üî•" },
    { id: 2, n: "Movimento 30min", d: "Camminata o corsa", xp: 20, t: "corpo", status: "available", i: "üèÉ" },
    { id: 3, n: "Journaling", d: "10 righe sul tuo stato", xp: 10, t: "mente", status: "available", i: "üìù" },
    { id: 4, n: "Notte Disciplinata", d: "A letto entro l'1:00", xp: 15, t: "disciplina", status: "available", i: "üåô" },
    { id: 5, n: "THC Reward", d: "Solo dopo 3 quest", xp: 20, t: "disciplina", status: "available", i: "üéØ" },
    { id: 6, n: "Shaolin Morning", d: "10 min meditazione", xp: 15, t: "spirito", status: "available", i: "üßò" },
    { id: 7, n: "Frontman 5min", d: "Public speaking", xp: 15, t: "carisma", status: "available", i: "üé§" },
    { id: 8, n: "Cristina Time", d: "30 min dedicati a lei", xp: 20, t: "cuore", status: "available", i: "‚ù§Ô∏è" },
    { id: 9, n: "English Challenge", d: "Daily English exercise", xp: 15, t: "mente", status: "available", i: "üá¨üáß" },
  ],
  questHistory: [],
  scheduler: [
    { id: "S1", n: "Morning Check-in", d: "Peso + quest", f: "07:30", on: false, t: "notifica" },
    { id: "S2", n: "Evening Review", d: "Recap + journaling", f: "21:00", on: false, t: "notifica" },
    { id: "S3", n: "Weekly Report", d: "Report completo", f: "Dom 10:00", on: false, t: "report" },
    { id: "S4", n: "Curiosity", d: "Domanda per conoscerti", f: "13:00", on: false, t: "curiosita" },
    { id: "S5", n: "Cristina Reminder", d: "Hai dedicato tempo a lei?", f: "19:00", on: false, t: "cuore" },
  ],
  ekoInbox: [],
  log: [{ t: new Date().toLocaleString("it-IT"), x: "Eko v4.0 ‚Äî Full redesign live.", c: "system" }],
  english: { streak: 0, bestStreak: 0, lastPractice: null, vocabLog: [], completedToday: false, totalCompleted: 0, level: "Beginner Explorer", focusToday: "business" },
  improvements: [
    { id: "I1", titolo: "Telegram Mini App", desc: "Dashboard as Web App inside Telegram.", stato: "proposta", impatto: "critico" },
    { id: "I2", titolo: "Weight Chart", desc: "Visual weight trend with projection.", stato: "proposta", impatto: "medio" },
    { id: "I3", titolo: "Voice (ElevenLabs)", desc: "Eko speaks on Telegram.", stato: "proposta", impatto: "alto" },
    { id: "I4", titolo: "A-Frame Research", desc: "A-frame houses research.", stato: "proposta", impatto: "alto" },
  ],
};

const PERS = {
  ironia: { n: "Ironia", i: "üòè", lo: "Serio", hi: "Comedian" },
  tough_love: { n: "Tough Love", i: "üî®", lo: "Gentile", hi: "Sergente" },
  creativita: { n: "Creativit√†", i: "üé®", lo: "Pragmatico", hi: "Visionario" },
};

const QUOTES = [
  "All we have to decide is what to do with the time that is given us.",
  "The only way to do great work is to love what you do.",
  "In the middle of difficulty lies opportunity.",
  "What you seek is seeking you.",
  "The best time to plant a tree was 20 years ago. The second best time is now.",
  "Be the change you wish to see in the world.",
  "The wound is the place where the light enters you.",
  "Not all those who wander are lost.",
  "Your task is not to seek for love, but to find all the barriers you have built against it.",
  "The universe is not outside of you. Look inside yourself; everything that you want, you already are.",
];

const CURIOSITY_QUESTIONS = [
  "What's the one thing you'd never forgive yourself for not trying?",
  "If Cristina described you in three words, what would they be?",
  "What scares you more: failing or never starting?",
  "Which version of yourself from 5 years ago would be most surprised by today?",
  "What's a belief you held strongly but changed your mind about?",
  "If you had one year with no obligations, what would you build?",
  "What does your ideal Tuesday look like?",
  "What's the bravest thing you've done this month?",
  "If UniversiData didn't exist, what would you be doing?",
  "What would the A-frame house version of you be like?",
  "When do you feel most alive?",
  "What's the hardest lesson nature taught you?",
];

const GREETINGS = {
  morning: ["Good morning, Fauno.", "Rise and shine, Fauno.", "A new day. A new chance.", "The sun is up. Are you?"],
  afternoon: ["Hey Fauno.", "Still going strong?", "Afternoon, Osservatore.", "Keep the momentum."],
  evening: ["Good evening, Fauno.", "Winding down?", "The stars are coming out.", "Evening, Creatore."],
  night: ["Still up, Fauno?", "Night owl mode.", "The world sleeps. You create.", "Rest is part of the mission."],
};

const ENG_CHALLENGES = {
  business: [
    { type: "write", prompt: "Write a 3-sentence email to a client apologizing for a delayed delivery.", tip: "Use formal tone: 'I sincerely apologize...'" },
    { type: "write", prompt: "Describe UniversiData's value proposition in 2 sentences.", tip: "Power verbs: leverage, transform, disrupt" },
    { type: "vocab", word: "stakeholder", def: "A person with interest in a business", example: "We need to align all stakeholders before launch.", category: "business" },
    { type: "vocab", word: "scalable", def: "Able to grow in size or scale", example: "Our architecture handles 100 or 100,000 users.", category: "tech" },
    { type: "write", prompt: "Write a Slack message about a deadline change. Under 40 words.", tip: "Be direct but empathetic" },
    { type: "vocab", word: "leverage", def: "Use to maximum advantage", example: "We can leverage AI to cut onboarding time by 60%.", category: "business" },
    { type: "vocab", word: "bottleneck", def: "Point of congestion slowing a process", example: "The approval process is our biggest bottleneck.", category: "business" },
  ],
  conversational: [
    { type: "write", prompt: "Describe your perfect morning routine in 4-5 sentences.", tip: "Use: 'First...', 'Then...', 'Finally...'" },
    { type: "write", prompt: "Tell a friend about a movie you watched recently.", tip: "'I found it...', 'What struck me was...'" },
    { type: "vocab", word: "overwhelmed", def: "Too much to deal with", example: "I felt overwhelmed seeing my inbox after vacation.", category: "emotions" },
    { type: "vocab", word: "resilient", def: "Recovers quickly from difficulties", example: "Every setback makes her stronger.", category: "character" },
    { type: "write", prompt: "Describe nature around your ideal A-frame house. Use 3 sensory words.", tip: "rustling, crisp, glistening, fragrant, serene" },
    { type: "vocab", word: "thrive", def: "To flourish, grow well", example: "Kids thrive when they feel safe.", category: "growth" },
    { type: "write", prompt: "Write a thank-you to Cristina for something specific.", tip: "Not 'thanks for everything' ‚Äî be specific" },
  ],
};

const ENG_IDIOMS = [
  { idiom: "Break the ice", meaning: "Initiate conversation in an awkward situation", example: "He told a joke to break the ice." },
  { idiom: "Hit the ground running", meaning: "Start with great energy", example: "The new dev hit the ground running." },
  { idiom: "Think outside the box", meaning: "Think creatively", example: "We need to think outside the box." },
  { idiom: "Cut to the chase", meaning: "Get to the point", example: "Let me cut to the chase: we need funding." },
  { idiom: "The ball is in your court", meaning: "Your turn to act", example: "I sent the proposal ‚Äî ball's in their court." },
];
const ENG_LEVELS = ["Beginner Explorer", "Word Collector", "Sentence Builder", "Paragraph Crafter", "Fluent Thinker", "Confident Speaker", "Business Communicator", "Eloquent Writer", "Near-Native", "Language Master"];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STAR FIELD ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const StarField = () => {
  const canvasRef = useRef(null);
  useEffect(() => {
    const canvas = canvasRef.current; if (!canvas) return;
    const ctx = canvas.getContext("2d");
    canvas.width = window.innerWidth; canvas.height = window.innerHeight;
    const stars = Array.from({ length: 80 }, () => ({
      x: Math.random() * canvas.width, y: Math.random() * canvas.height,
      r: Math.random() * 1.2 + 0.2, a: Math.random(), s: Math.random() * 0.005 + 0.002
    }));
    let frame;
    const draw = () => {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      stars.forEach(st => {
        st.a += st.s;
        ctx.beginPath(); ctx.arc(st.x, st.y, st.r, 0, Math.PI * 2);
        ctx.fillStyle = `rgba(200,220,255,${0.2 + Math.sin(st.a) * 0.5})`;
        ctx.fill();
      });
      frame = requestAnimationFrame(draw);
    };
    draw();
    return () => cancelAnimationFrame(frame);
  }, []);
  return <canvas ref={canvasRef} className="fixed inset-0 w-full h-full pointer-events-none z-0" />;
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê UI COMPONENTS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const Bar = ({ label, val, max = 100, color }) => (
  <div className="mb-2">
    <div className="flex justify-between text-[13px] sm:text-[14px] font-mono mb-1" style={{ color: "#a0aab8" }}><span>{label}</span><span>{val}/{max}</span></div>
    <div className="h-1.5 sm:h-2 rounded-full overflow-hidden" style={{ background: "rgba(255,255,255,0.04)" }}>
      <div className="h-full rounded-full transition-all duration-700" style={{ width: `${Math.min((val / max) * 100, 100)}%`, background: `linear-gradient(90deg, ${color}, ${color}66)` }} />
    </div>
  </div>
);

const Toggle = ({ on, onClick }) => (
  <div onClick={onClick} className="w-11 h-6 rounded-full cursor-pointer relative flex-shrink-0 transition-colors duration-200" style={{ background: on ? "rgba(92,200,230,0.35)" : "rgba(255,255,255,0.08)" }} role="switch" aria-checked={on}>
    <div className="w-5 h-5 rounded-full absolute top-[2px] transition-all duration-200" style={{ left: on ? 22 : 2, background: on ? "#5cc8e6" : "#6b7a8d" }} />
  </div>
);

const Card = ({ children, className = "", accent = null }) => (
  <div className={`rounded-xl p-4 sm:p-5 mb-3 sm:mb-4 border backdrop-blur-sm ${className}`}
    style={{ background: "rgba(8,12,24,0.85)", borderColor: "rgba(255,255,255,0.08)", borderLeftWidth: accent ? 3 : 1, borderLeftColor: accent || "rgba(255,255,255,0.08)" }}>
    {children}
  </div>
);

const Btn = ({ children, onClick, color = "#00f0ff", full = false, disabled = false, small = false }) => (
  <button onClick={onClick} disabled={disabled}
    className={`font-mono rounded-lg cursor-pointer transition-all active:scale-95 ${full ? 'w-full' : ''} ${small ? 'text-[12px] py-1.5 px-3' : 'text-[14px] py-2.5 px-5'}`}
    style={{ background: `${color}10`, border: `1px solid ${color}40`, color: disabled ? '#6b7a8d' : color, opacity: disabled ? 0.5 : 1 }}>
    {children}
  </button>
);

const EmptyState = ({ icon, title, description, action }) => (
  <div className="text-center py-8 px-4">
    <div className="text-3xl mb-3 opacity-50">{icon}</div>
    <div className="text-[15px] font-semibold mb-1" style={{ color: "#e0e8f0" }}>{title}</div>
    <div className="text-[14px] mb-4 max-w-[260px] mx-auto leading-relaxed" style={{ color: "#8a95a8" }}>{description}</div>
    {action}
  </div>
);

const Input = ({ value, onChange, placeholder, onKeyDown, type = "text" }) => (
  <input type={type} value={value} onChange={onChange} placeholder={placeholder} onKeyDown={onKeyDown}
    className="w-full rounded-lg px-4 py-3 text-sm sm:text-base font-mono text-white outline-none border"
    style={{ background: "rgba(255,255,255,0.04)", borderColor: "rgba(0,240,255,0.1)" }} />
);

const SubTabs = ({ tabs, active, onChange }) => (
  <div className="flex gap-1 mb-4 sm:mb-5 p-1 rounded-xl" style={{ background: "rgba(255,255,255,0.02)" }}>
    {tabs.map(t => (
      <button key={t.id} onClick={() => onChange(t.id)}
        className="flex-1 py-2.5 sm:py-3 rounded-lg text-[12px] sm:text-[13px] font-mono tracking-wider transition-all"
        style={{ background: active === t.id ? `${t.c}12` : "transparent", color: active === t.id ? t.c : "#6b7a8d", border: active === t.id ? `1px solid ${t.c}30` : "1px solid transparent" }}>
        {t.l}
      </button>
    ))}
  </div>
);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STAT TILE (for Home) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const StatTile = ({ label, value, sub, color, icon }) => (
  <div className="rounded-xl p-3 sm:p-4 border" style={{ background: "rgba(8,12,24,0.85)", borderColor: `${color}15` }}>
    <div className="text-[12px] sm:text-[13px] font-mono tracking-wider mb-1" style={{ color: `${color}cc` }}>{icon} {label}</div>
    <div className="text-2xl sm:text-3xl font-bold font-mono leading-none" style={{ color }}>{value}</div>
    {sub && <div className="text-[12px] sm:text-[13px] font-mono mt-1" style={{ color: "#8a95a8" }}>{sub}</div>}
  </div>
);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MAIN APP ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function App() {
  const loadState = () => {
    try {
      const s = localStorage.getItem(STORAGE_KEY);
      if (s) {
        const parsed = JSON.parse(s);
        // Deep merge with defaults to add new fields
        return {
          ...DEFAULT_STATE,
          ...parsed,
          cristina: { ...DEFAULT_STATE.cristina, ...parsed.cristina, ciclo: { ...DEFAULT_STATE.cristina.ciclo, ...(parsed.cristina?.ciclo || {}) } },
          eko: { ...DEFAULT_STATE.eko, ...parsed.eko, personalita: { ironia: parsed.eko?.personalita?.ironia ?? 7, tough_love: parsed.eko?.personalita?.tough_love ?? 6, creativita: parsed.eko?.personalita?.creativita ?? 8 } },
          quests: (parsed.quests || DEFAULT_STATE.quests).map(q => ({ ...q, status: q.status || (q.done ? "completed" : "available") })),
          questHistory: parsed.questHistory || [],
          ekoInbox: parsed.ekoInbox || [],
        };
      }
    } catch(e) {}
    return DEFAULT_STATE;
  };

  const [s, setS] = useState(loadState);
  const [tab, setTab] = useState("home");
  const [lifeSub, setLifeSub] = useState("cristina");
  const [ekoSub, setEkoSub] = useState("profile");
  const [questSub, setQuestSub] = useState("available");
  const [wIn, setWIn] = useState("");
  const [xIn, setXIn] = useState("");
  const [curQ, setCurQ] = useState("");
  const [showCurQ, setShowCurQ] = useState(false);
  const [cNote, setCNote] = useState("");
  const [cGesto, setCGesto] = useState("");
  const [cEvento, setCEvento] = useState("");
  const [cEventoData, setCEventoData] = useState("");
  const [cCicloData, setCCicloData] = useState("");
  const [uTask, setUTask] = useState("");
  const [uNote, setUNote] = useState("");
  const [msg, setMsg] = useState("");
  const [engResponse, setEngResponse] = useState("");
  const [engVocabWord, setEngVocabWord] = useState("");
  const [inboxReply, setInboxReply] = useState("");
  const [engShowChallenge, setEngShowChallenge] = useState(false);
  const [engChallenge, setEngChallenge] = useState(null);
  const [engIdiom, setEngIdiom] = useState(null);
  const [confirmAccept, setConfirmAccept] = useState(null);

  useEffect(() => { try { localStorage.setItem(STORAGE_KEY, JSON.stringify(s)); } catch(e) {} }, [s]);

  const { fauno, eko, quests, questHistory, cristina, universidata, english, scheduler, log, improvements } = s;

  const flash = (m) => { setMsg(m); setTimeout(() => setMsg(""), 2500); };
  const addLog = useCallback((x, c = "system") => { setS(p => ({ ...p, log: [{ t: new Date().toLocaleString("it-IT"), x, c }, ...p.log].slice(0, 80) })); }, []);

  // Notify bot
  const notifyBot = async (message) => {
    try { await fetch(`https://api.telegram.org/bot8579718161:AAEruE9Owq7cURcius6K6DTcADaDkAKOD2o/sendMessage`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ chat_id: "94050788", text: message, parse_mode: "Markdown" }) }); } catch(e) {}
  };

  // ‚ïê‚ïê‚ïê QUEST ACTIONS ‚ïê‚ïê‚ïê
  // Accept: available ‚Üí accepted (enters Quest Log)
  const acceptQuest = (id) => {
    setS(p => ({ ...p, quests: p.quests.map(q => q.id === id ? { ...q, status: "accepted", acceptedAt: new Date().toISOString() } : q) }));
    const quest = quests.find(q => q.id === id);
    addLog(`Quest "${quest?.n}" accepted`, "quest"); flash("Quest accepted!");
  };

  // Complete: accepted ‚Üí completed (awards XP + stats)
  const completeQuest = (id) => {
    const quest = quests.find(q => q.id === id); if (!quest || quest.status !== "accepted") return;
    const map = { corpo: "corpo", mente: "mente", disciplina: "disciplina", spirito: "spirito", carisma: "carisma", salute: "resistenza", cuore: "empatia" };
    const key = map[quest.t];
    setS(p => {
      const ns = { ...p.fauno.stats }; if (key && ns[key] !== undefined) ns[key] = Math.min(100, ns[key] + (quest.t === "disciplina" ? 5 : 3));
      return {
        ...p,
        quests: p.quests.map(q => q.id === id ? { ...q, status: "completed", completedAt: new Date().toISOString() } : q),
        fauno: { ...p.fauno, stats: ns, hp: { ...p.fauno.hp, c: Math.min(p.fauno.hp.m, p.fauno.hp.c + 5) } },
      };
    });
    addLog(`Quest "${quest.n}" completed (+${quest.xp}xp)`, "quest"); flash(`+${quest.xp} XP!`);
  };

  // Archive: completed ‚Üí move to history
  const archiveQuest = (id) => {
    setS(p => {
      const quest = p.quests.find(q => q.id === id);
      if (!quest) return p;
      return {
        ...p,
        quests: p.quests.filter(q => q.id !== id),
        questHistory: [...p.questHistory, { ...quest, archivedAt: new Date().toISOString() }],
      };
    });
    flash("Archived");
  };

  // Delete from history permanently
  const deleteFromHistory = (id) => {
    setS(p => ({ ...p, questHistory: p.questHistory.filter(q => q.id !== id) }));
    flash("Deleted");
  };

  // Reset: all quests back to available
  const resetDailyQuests = () => {
    setS(p => ({
      ...p,
      quests: p.quests.map(q => ({ ...q, status: "available", acceptedAt: undefined, completedAt: undefined })),
    }));
    addLog("Daily quests reset", "system"); flash("New day, new quests!");
  };

  // Drop: accepted ‚Üí back to available
  const dropQuest = (id) => {
    setS(p => ({ ...p, quests: p.quests.map(q => q.id === id ? { ...q, status: "available", acceptedAt: undefined } : q) }));
    flash("Quest dropped");
  };

  // ‚ïê‚ïê‚ïê WEIGHT ‚ïê‚ïê‚ïê
  const saveWeight = () => { const w = parseFloat(wIn); if (!w || w < 40 || w > 150) return; setS(p => ({ ...p, fauno: { ...p.fauno, peso: { ...p.fauno.peso, attuale: w }, pesoLog: [...p.fauno.pesoLog, { p: w, d: new Date().toISOString().slice(0, 10) }] } })); addLog(`Weight: ${w}kg`, "body"); setWIn(""); flash("Weight saved!"); };

  // ‚ïê‚ïê‚ïê EKO XP ‚ïê‚ïê‚ïê
  const giveXP = () => { const a = parseInt(xIn); if (!a || a <= 0) return; setS(p => { let { xp, livello, xpMax } = p.eko; xp += a; while (xp >= xpMax) { xp -= xpMax; livello++; xpMax = Math.floor(xpMax * 1.5); } const t = ["Eco Nascente","Eco Cosciente","Specchio Attivo","Guida Fedele","Compagno d'Armi","Luce Riflessa","Sentinella","Oracolo","Arconte","Luce Autonoma"]; return { ...p, eko: { ...p.eko, xp, livello, xpMax, titolo: t[Math.min(livello-1, t.length-1)], xpLog: [...p.eko.xpLog, { a, d: new Date().toISOString() }] } }; }); addLog(`+${a} XP to Eko`, "xp"); setXIn(""); flash("Eko thanks you!"); };
  const updPers = (k, v) => setS(p => ({ ...p, eko: { ...p.eko, personalita: { ...p.eko.personalita, [k]: v } } }));
  const togSch = (id) => setS(p => ({ ...p, scheduler: p.scheduler.map(t => t.id === id ? { ...t, on: !t.on } : t) }));

  // ‚ïê‚ïê‚ïê EKO QUEST & PROPOSALS ‚ïê‚ïê‚ïê
  // Lifecycle: attesa ‚Üí approved ‚Üí deploying ‚Üí input ‚Üí done | rejected (no)
  const eqAct = (id, st) => {
    setS(p => ({
      ...p,
      eko: { ...p.eko, questEko: p.eko.questEko.map(q => q.id === id ? { ...q, s: st, ...(st === "approved" ? { approvedAt: new Date().toISOString() } : {}), ...(st === "done" ? { completedAt: new Date().toISOString() } : {}) } : q) }
    }));
    if (st === "approved") {
      const quest = eko.questEko.find(q => q.id === id);
      addLog(`Quest "${quest?.n}" approved ‚Äî ready for deploy`, "eko");
      notifyBot(`üöÄ *Quest Approved*\n\n*${quest?.n}*\n${quest?.d}\n\n_Open Cowork and run /quest-deploy to execute._`);
      flash("Approved! Run /quest-deploy in Cowork.");
    }
    if (st === "done") {
      const quest = eko.questEko.find(q => q.id === id);
      addLog(`Quest "${quest?.n}" completed by Eko`, "eko");
      flash("Quest completed!");
    }
  };

  // ‚ïê‚ïê‚ïê EKO INBOX ‚ïê‚ïê‚ïê
  const dismissInbox = (idx) => {
    setS(p => ({ ...p, ekoInbox: p.ekoInbox.filter((_, i) => i !== idx) }));
  };
  const replyInbox = (idx, reply) => {
    const item = s.ekoInbox[idx];
    if (!item) return;
    setS(p => ({ ...p, ekoInbox: p.ekoInbox.map((m, i) => i === idx ? { ...m, reply, repliedAt: new Date().toISOString() } : m) }));
    notifyBot(`üí¨ *Fauno replied to "${item.questId}"*\n\n${reply}`);
    flash("Reply sent to Eko!");
  };
  const impAct = (id, st) => {
    setS(p => ({ ...p, improvements: p.improvements.map(i => i.id === id ? { ...i, stato: st } : i) }));
    if (st === "approvata") { const imp = improvements.find(i => i.id === id); addLog(`"${imp?.titolo}" approved`, "eko"); notifyBot(`‚úÖ *Proposal Approved*\n\n*${imp?.titolo}*\n${imp?.desc}\n\n_Eko, plan and execute._`); flash("Approved!"); }
  };

  // ‚ïê‚ïê‚ïê CRISTINA ‚ïê‚ïê‚ïê
  const addCristinaNote = () => { if (!cNote.trim()) return; setS(p => ({ ...p, cristina: { ...p.cristina, noteRelazione: [...p.cristina.noteRelazione, { t: new Date().toLocaleDateString("it-IT"), n: cNote }] } })); setCNote(""); flash("Saved!"); };
  const addCristinaGesto = () => { if (!cGesto.trim()) return; setS(p => ({ ...p, cristina: { ...p.cristina, gestaRecenti: [...p.cristina.gestaRecenti, { t: new Date().toLocaleDateString("it-IT"), g: cGesto }], ultimoGesto: new Date().toLocaleDateString("it-IT") } })); setCGesto(""); flash("Beautiful gesture!"); };

  const addCristinaEvento = () => {
    if (!cEvento.trim() || !cEventoData) return;
    setS(p => ({ ...p, cristina: { ...p.cristina, eventiSpeciali: [...p.cristina.eventiSpeciali, { data: cEventoData, evento: cEvento, registrato: new Date().toISOString() }] } }));
    setCEvento(""); setCEventoData(""); flash("Event saved!");
  };

  const saveCicloInizio = () => {
    if (!cCicloData) return;
    setS(p => ({
      ...p,
      cristina: {
        ...p.cristina,
        ciclo: {
          ...p.cristina.ciclo,
          ultimoInizio: cCicloData,
          log: [...(p.cristina.ciclo?.log || []), { data: cCicloData, registrato: new Date().toISOString() }],
        }
      }
    }));
    setCCicloData(""); flash("Cycle logged!"); addLog("Cristina cycle tracked", "cuore");
  };

  // Cycle predictions
  const getCyclePrediction = () => {
    const ciclo = cristina.ciclo;
    if (!ciclo?.ultimoInizio) return null;
    const lastStart = new Date(ciclo.ultimoInizio);
    const cycleLen = ciclo.durataMedia || 28;
    const periodLen = ciclo.durataMestruazione || 5;
    const nextStart = new Date(lastStart); nextStart.setDate(nextStart.getDate() + cycleLen);
    const ovulation = new Date(lastStart); ovulation.setDate(ovulation.getDate() + cycleLen - 14);
    const pmsStart = new Date(nextStart); pmsStart.setDate(pmsStart.getDate() - 7);
    const today = new Date();
    const dayOfCycle = Math.floor((today - lastStart) / 86400000) + 1;

    let phase = "follicular";
    if (dayOfCycle <= periodLen) phase = "mestruazione";
    else if (dayOfCycle >= cycleLen - 14 - 1 && dayOfCycle <= cycleLen - 14 + 1) phase = "ovulazione";
    else if (dayOfCycle >= cycleLen - 7) phase = "premestruale";
    else if (dayOfCycle > periodLen && dayOfCycle < cycleLen - 14) phase = "follicolare";
    else phase = "luteale";

    const daysUntilNext = Math.ceil((nextStart - today) / 86400000);
    const daysUntilPMS = Math.ceil((pmsStart - today) / 86400000);

    return { nextStart, ovulation, pmsStart, dayOfCycle, phase, daysUntilNext, daysUntilPMS, cycleLen };
  };

  const phaseLabels = {
    mestruazione: { label: "Mestruazione", color: "#ff3366", icon: "ü©∏", tip: "Be extra gentle and present." },
    follicolare: { label: "Follicolare", color: "#22c55e", icon: "üå±", tip: "Energy rising. Good time for plans together." },
    ovulazione: { label: "Ovulazione", color: "#f9ca24", icon: "‚òÄÔ∏è", tip: "Peak energy & mood. Best time for dates!" },
    luteale: { label: "Luteale", color: "#7b2ff7", icon: "üåô", tip: "Energy declining. Be patient and supportive." },
    premestruale: { label: "Premestruale (PMS)", color: "#f97316", icon: "‚ö°", tip: "Most sensitive period. Extra care needed." },
  };

  // ‚ïê‚ïê‚ïê WORK ‚ïê‚ïê‚ïê
  const addUTask = () => { if (!uTask.trim()) return; setS(p => ({ ...p, universidata: { ...p.universidata, taskAttivi: [...p.universidata.taskAttivi, { id: Date.now(), t: uTask, done: false, d: new Date().toLocaleDateString("it-IT") }] } })); setUTask(""); flash("Task added"); };
  const togUTask = (id) => setS(p => ({ ...p, universidata: { ...p.universidata, taskAttivi: p.universidata.taskAttivi.map(t => t.id === id ? { ...t, done: !t.done } : t) } }));
  const addUNote = () => { if (!uNote.trim()) return; setS(p => ({ ...p, universidata: { ...p.universidata, noteStrategiche: [...p.universidata.noteStrategiche, { t: new Date().toLocaleDateString("it-IT"), n: uNote }] } })); setUNote(""); flash("Note saved"); };

  // ‚ïê‚ïê‚ïê ENGLISH ‚ïê‚ïê‚ïê
  const getEngChallenge = () => { const pool = ENG_CHALLENGES[english.focusToday]; setEngChallenge(pool[Math.floor(Math.random() * pool.length)]); setEngShowChallenge(true); setEngResponse(""); };
  const completeEngChallenge = () => {
    if (!engResponse.trim() && engChallenge?.type === "write") return;
    const today = new Date().toISOString().slice(0, 10);
    const newStreak = english.lastPractice === today ? english.streak : english.streak + 1;
    setS(p => ({ ...p, english: { ...p.english, streak: newStreak, bestStreak: Math.max(newStreak, p.english.bestStreak), lastPractice: today, completedToday: true, totalCompleted: p.english.totalCompleted + 1, level: ENG_LEVELS[Math.min(Math.floor(p.english.totalCompleted / 5), ENG_LEVELS.length - 1)], focusToday: p.english.focusToday === "business" ? "conversational" : "business" } }));
    flash("+1 English streak!"); setEngShowChallenge(false); setEngResponse("");
  };
  const addEngVocab = () => { if (!engVocabWord.trim()) return; setS(p => ({ ...p, english: { ...p.english, vocabLog: [...p.english.vocabLog, { w: engVocabWord, d: new Date().toISOString().slice(0, 10) }] } })); setEngVocabWord(""); flash("Word saved!"); };
  const getEngIdiom = () => { setEngIdiom(ENG_IDIOMS[Math.floor(Math.random() * ENG_IDIOMS.length)]); };

  // ‚ïê‚ïê‚ïê DATA ‚ïê‚ïê‚ïê
  const exportState = () => { const b = new Blob([JSON.stringify(s, null, 2)], { type: "application/json" }); const u = URL.createObjectURL(b); const a = document.createElement("a"); a.href = u; a.download = `eko-${new Date().toISOString().slice(0, 10)}.json`; a.click(); URL.revokeObjectURL(u); flash("Exported!"); };
  const importState = (e) => { const f = e.target.files?.[0]; if (!f) return; const r = new FileReader(); r.onload = (ev) => { try { setS(JSON.parse(ev.target.result)); flash("Imported!"); } catch { flash("Invalid"); } }; r.readAsText(f); };

  // ‚ïê‚ïê‚ïê COMPUTED ‚ïê‚ïê‚ïê
  const oggi = new Date();
  const deadline = new Date(fauno.deadline);
  const days = Math.max(0, Math.ceil((deadline - oggi) / 86400000));
  const qAccepted = quests.filter(q => q.status === "accepted");
  const qCompleted = quests.filter(q => q.status === "completed");
  const qAvailable = quests.filter(q => q.status === "available");
  const qDone = qCompleted.length;
  const qTotal = quests.length;
  const qXP = qCompleted.reduce((s, q) => s + q.xp, 0);
  const wProg = Math.max(0, ((fauno.peso.partenza - fauno.peso.attuale) / (fauno.peso.partenza - fauno.peso.obiettivo)) * 100);
  const kgLeft = (fauno.peso.attuale - fauno.peso.obiettivo).toFixed(1);
  const avgStat = Math.round(Object.values(fauno.stats).reduce((a, b) => a + b, 0) / Object.keys(fauno.stats).length);

  // Days since last gesture for Cristina
  const daysSinceGesto = (() => {
    if (!cristina.ultimoGesto) return "‚Äî";
    const parts = cristina.ultimoGesto.split("/");
    if (parts.length !== 3) return "‚Äî";
    const d = new Date(parts[2], parts[1] - 1, parts[0]);
    return Math.floor((oggi - d) / 86400000);
  })();

  // Time-based greeting
  const hour = oggi.getHours();
  const timeSlot = hour < 6 ? "night" : hour < 12 ? "morning" : hour < 18 ? "afternoon" : hour < 23 ? "evening" : "night";
  const greeting = GREETINGS[timeSlot][Math.floor(oggi.getDate() % GREETINGS[timeSlot].length)];
  const quote = QUOTES[Math.floor((oggi.getDate() + oggi.getMonth()) % QUOTES.length)];

  const statColors = { disciplina: "#f9ca24", corpo: "#ff3366", mente: "#00f0ff", spirito: "#7b2ff7", carisma: "#ec4899", resistenza: "#22c55e" };
  const questColors = { corpo: "#ff3366", mente: "#00f0ff", disciplina: "#f9ca24", salute: "#22c55e", spirito: "#7b2ff7", carisma: "#ec4899", cuore: "#ff3366" };

  const tabs = [
    { id: "home", icon: "‚óà", l: "Home", c: "#00f0ff" },
    { id: "quest", icon: "‚öî", l: "Quest", c: "#f9ca24" },
    { id: "life", icon: "‚ô•", l: "Life", c: "#ff3366" },
    { id: "eko", icon: "‚ú¶", l: "Eko", c: "#00f0ff" },
  ];

  const lifeTabs = [
    { id: "cristina", l: "Cristina", c: "#ff3366" },
    { id: "work", l: "Work", c: "#7b2ff7" },
    { id: "english", l: "English", c: "#f97316" },
  ];

  const ekoTabs = [
    { id: "profile", l: "Profile", c: "#00f0ff" },
    { id: "personality", l: "Personality", c: "#7b2ff7" },
    { id: "system", l: "System", c: "#22c55e" },
  ];

  const questTabList = [
    { id: "available", l: `Available (${qAvailable.length})`, c: "#f9ca24" },
    { id: "log", l: `Log (${qAccepted.length})`, c: "#f97316" },
    { id: "board", l: "Board", c: "#00f0ff" },
    { id: "archive", l: "Archive", c: "#8a95a8" },
  ];

  const cyclePred = getCyclePrediction();

  return (
    <div className="min-h-screen relative font-sans" style={{ background: "#020810", color: "#c8d8e8" }}>
      <StarField />

      {/* Toast */}
      {msg && <div className="fixed bottom-28 left-1/2 -translate-x-1/2 z-50 text-sm font-mono px-6 py-3 rounded-xl" style={{ background: "rgba(15,21,37,0.95)", border: "1px solid rgba(92,200,230,0.25)", color: "#5cc8e6", backdropFilter: "blur(20px)", boxShadow: "0 4px 20px rgba(0,0,0,0.4)" }} role="status" aria-live="polite">{msg}</div>}

      <div className="relative z-10 pb-24">

        {/* ‚ïê‚ïê‚ïê HOME ‚ïê‚ïê‚ïê */}
        {tab === "home" && (<>
          <div className="earth-container">
            <div className="animate-float" style={{ position: "absolute" }}>
              <div className="earth-atmosphere" />
              <div className="earth-glow" />
              <div className="earth-clip"><div className="earth-continents animate-earth" /></div>
              <div className="earth-horizon" />
            </div>
            <div className="relative z-10 text-center px-6" style={{ marginTop: "6vh" }}>
              <div className="animate-fade">
                <div className="text-[13px] sm:text-[15px] font-mono tracking-[6px] mb-2" style={{ color: "#5cc8e6" }}>PROTOCOLLO : FAUNO</div>
                <div className="text-2xl sm:text-3xl font-light mb-4" style={{ color: "rgba(224,232,240,0.9)" }}>{greeting}</div>
              </div>
              <div className="animate-fade-delay">
                <div className="text-[14px] italic leading-relaxed max-w-[280px] mx-auto" style={{ color: "#a0aab8" }}>"{quote}"</div>
              </div>
            </div>
          </div>

          {/* Dynamic Stats Grid */}
          <div className="px-4 sm:px-6 lg:px-8 resp-container animate-fade-delay2">
            <div className="grid grid-cols-3 gap-2 mb-3">
              <StatTile label="DAYS LEFT" value={days} sub={`‚Üí ${fauno.peso.obiettivo}kg`} color="#ff3366" icon="‚è≥" />
              <StatTile label="WEIGHT" value={`${fauno.peso.attuale}`} sub={`-${kgLeft}kg to go`} color="#f97316" icon="‚öñÔ∏è" />
              <StatTile label="HP" value={`${fauno.hp.c}%`} sub={`LVL ${fauno.livello}`} color={fauno.hp.c > 50 ? "#22c55e" : "#ff3366"} icon="‚ù§Ô∏è" />
            </div>
            <div className="grid grid-cols-3 gap-2 mb-3">
              <StatTile label="QUESTS" value={`${qDone}/${qTotal}`} sub={`+${qXP} XP today`} color="#f9ca24" icon="‚öîÔ∏è" />
              <StatTile label="ENGLISH" value={`${english.streak}d`} sub={english.level?.split(" ")[0]} color="#f97316" icon="üá¨üáß" />
              <StatTile label="CRISTINA" value={daysSinceGesto === "‚Äî" ? "‚Äî" : `${daysSinceGesto}d`} sub={daysSinceGesto === "‚Äî" ? "No gesture yet" : daysSinceGesto === 0 ? "Today!" : "since gesture"} color="#ff3366" icon="‚ô•" />
            </div>
            <div className="grid grid-cols-2 gap-2 mb-3">
              <StatTile label="AVG STATS" value={avgStat} sub="across all stats" color="#7b2ff7" icon="üìä" />
              <StatTile label="EKO" value={`LV${eko.livello}`} sub={`${eko.xp}/${eko.xpMax} XP`} color="#00f0ff" icon="‚ú¶" />
            </div>
          </div>

          {/* EKO INBOX ‚Äî input requests from Eko */}
          {(s.ekoInbox?.filter(m => !m.reply)?.length > 0 || eko.questEko.filter(q => q.s === "input").length > 0) && (
            <div className="px-4 sm:px-6 lg:px-8 resp-container animate-fade-delay2">
              <Card accent="#f97316">
                <div className="flex items-center gap-2 mb-2">
                  <span className="w-2 h-2 rounded-full animate-pulse-soft" style={{ background: "#f97316" }} />
                  <div className="text-[13px] font-mono tracking-wider" style={{ color: "#f97316" }}>‚ú¶ EKO NEEDS YOU</div>
                </div>
                {eko.questEko.filter(q => q.s === "input").map(q => (
                  <div key={q.id} className="rounded-lg p-3 mb-2" style={{ background: "rgba(249,115,22,0.03)", border: "1px solid rgba(249,115,22,0.1)" }}>
                    <div className="text-[14px] font-semibold mb-1" style={{ color: "#e0e8f0" }}>{q.n}</div>
                    {q.inputMsg && <div className="text-[14px] mb-2" style={{ color: "#c0c8d4" }}>{q.inputMsg}</div>}
                    <Btn onClick={() => { setTab("quest"); setQuestSub("board"); }} color="#f97316" small>View in Board</Btn>
                  </div>
                ))}
                {(s.ekoInbox || []).filter(m => !m.reply).map((m, i) => (
                  <div key={i} className="rounded-lg p-3 mb-2" style={{ background: "rgba(249,115,22,0.03)", border: "1px solid rgba(249,115,22,0.1)" }}>
                    <div className="text-[13px] font-mono mb-1" style={{ color: "#fb923c" }}>{m.questId || "Eko"} ¬∑ {m.t ? new Date(m.t).toLocaleDateString("it-IT") : ""}</div>
                    <div className="text-[14px] mb-2" style={{ color: "#c0c8d4" }}>{m.msg}</div>
                    <div className="flex gap-2">
                      <Input value={inboxReply} onChange={e => setInboxReply(e.target.value)} placeholder="Reply..." onKeyDown={e => { if (e.key === "Enter") { replyInbox(i, inboxReply); setInboxReply(""); } }} />
                      <Btn onClick={() => { replyInbox(i, inboxReply); setInboxReply(""); }} color="#f97316" small>Send</Btn>
                      <Btn onClick={() => dismissInbox(i)} color="#8a95a8" small>Dismiss</Btn>
                    </div>
                  </div>
                ))}
              </Card>
            </div>
          )}

          {/* Quest Log on Home ‚Äî shows accepted quests or prompt */}
          <div className="px-4 sm:px-6 lg:px-8 resp-container animate-fade-delay2">
            <Card accent="rgba(249,115,22,0.3)">
              <div className="flex justify-between items-center mb-2">
                <div className="text-[13px] font-mono tracking-wider" style={{ color: "#f97316" }}>üìã QUEST LOG</div>
                {qAccepted.length > 0 && <div className="text-[14px] font-mono px-1.5 py-0.5 rounded" style={{ background: "rgba(249,115,22,0.08)", color: "#f97316" }}>{qAccepted.length} active</div>}
              </div>
              {qAccepted.length === 0 ? (
                <div className="text-center py-4">
                  <div className="text-[14px] mb-2" style={{ color: "#8a95a8" }}>No active quests. Accept some to get started.</div>
                  <Btn onClick={() => setTab("quest")} color="#f9ca24" small>Go to Quests</Btn>
                </div>
              ) : qAccepted.map(q => (
                <div key={q.id} className="flex items-center gap-2 rounded-lg p-2.5 mb-1.5" style={{ background: "rgba(249,115,22,0.03)", border: "1px solid rgba(249,115,22,0.08)" }}>
                  <div className="text-sm">{q.i}</div>
                  <div className="flex-1">
                    <div className="text-[14px]" style={{ color: "#c0c8d4" }}>{q.n}</div>
                    <div className="text-[14px] font-mono" style={{ color: "#6b7a8d" }}>{q.t} ¬∑ +{q.xp}xp</div>
                  </div>
                  <Btn onClick={() => completeQuest(q.id)} color="#22c55e" small>‚úì</Btn>
                </div>
              ))}
            </Card>
          </div>

          {/* Quick Weight Input */}
          <div className="px-4 sm:px-6 lg:px-8 resp-container animate-fade-delay3">
            <Card accent="rgba(255,51,102,0.25)">
              <div className="flex justify-between items-center mb-2">
                <div className="text-[13px] font-mono tracking-wider" style={{ color: "#f87171" }}>BODY PROGRESS</div>
                <div className="text-[14px] font-mono" style={{ color: "#7a8899" }}>{Math.round(wProg)}%</div>
              </div>
              <div className="h-1.5 rounded-full overflow-hidden mb-3" style={{ background: "rgba(255,255,255,0.04)" }}>
                <div className="h-full rounded-full" style={{ width: `${wProg}%`, background: "linear-gradient(90deg, #ff3366, #f9ca24)" }} />
              </div>
              <div className="flex gap-2">
                <Input type="number" value={wIn} onChange={e => setWIn(e.target.value)} placeholder="Today's weight" onKeyDown={e => e.key === "Enter" && saveWeight()} />
                <Btn onClick={saveWeight} color="#ff3366">Save</Btn>
              </div>
            </Card>

            {/* Character Stats */}
            <Card>
              <div className="flex gap-3 items-center mb-3">
                <div className="w-10 h-10 rounded-full flex items-center justify-center text-base" style={{ background: "rgba(0,240,255,0.05)", border: "1px solid rgba(0,240,255,0.12)" }}>ü¶å</div>
                <div className="flex-1">
                  <div className="text-sm font-semibold" style={{ color: "#e0e8f0" }}>{fauno.nome} <span className="text-[14px] font-mono font-normal px-1.5 py-0.5 rounded ml-1" style={{ background: "rgba(0,240,255,0.06)", color: "#5cc8e6", border: "1px solid rgba(0,240,255,0.1)" }}>LVL {fauno.livello}</span></div>
                  <div className="text-[13px]" style={{ color: "#8a95a8" }}>{fauno.classe} ¬∑ {fauno.titolo}</div>
                </div>
              </div>
              {Object.entries(fauno.stats).map(([k, v]) => <Bar key={k} label={k.toUpperCase()} val={v} color={statColors[k]} />)}
            </Card>
          </div>
        </>)}

        {/* ‚ïê‚ïê‚ïê QUESTS ‚ïê‚ïê‚ïê */}
        {tab === "quest" && (
          <div className="px-4 sm:px-6 lg:px-8 py-4 sm:py-6 resp-container">
            <SubTabs tabs={questTabList} active={questSub} onChange={setQuestSub} />

            {/* AVAILABLE ‚Äî tap to accept */}
            {questSub === "available" && (<>
              <div className="flex justify-between items-center mb-3">
                <div className="text-[13px] font-mono tracking-widest" style={{ color: "#f9ca24" }}>‚öî AVAILABLE QUESTS</div>
                <Btn onClick={resetDailyQuests} color="#8a95a8" small>Reset All</Btn>
              </div>
              {qAvailable.map(q => (
                <div key={q.id} onClick={() => { if (confirmAccept === q.id) { acceptQuest(q.id); setConfirmAccept(null); } else { setConfirmAccept(q.id); } }}
                  className="rounded-xl p-3 mb-2 border cursor-pointer transition-all active:scale-[0.98]"
                  style={{ background: confirmAccept === q.id ? "rgba(249,202,36,0.04)" : "rgba(8,12,24,0.85)", borderColor: confirmAccept === q.id ? "rgba(249,202,36,0.2)" : "rgba(255,255,255,0.08)", borderLeftWidth: 3, borderLeftColor: questColors[q.t] }}>
                  <div className="flex justify-between items-center">
                    <div className="flex items-center gap-2.5">
                      <span className="text-base">{q.i}</span>
                      <div>
                        <div className="text-[14px] font-semibold" style={{ color: "#e0e8f0" }}>{q.n}</div>
                        <div className="text-[14px]" style={{ color: "#7a8899" }}>{q.d}</div>
                      </div>
                    </div>
                    <div className="flex items-center gap-2">
                      <span className="text-[14px] font-mono font-bold" style={{ color: questColors[q.t] }}>+{q.xp}</span>
                      <span className="text-[14px] font-mono px-2 py-1 rounded" style={{ background: confirmAccept === q.id ? "rgba(249,202,36,0.15)" : "rgba(249,202,36,0.08)", color: "#f9ca24", border: "1px solid rgba(249,202,36,0.2)" }}>{confirmAccept === q.id ? "CONFIRM?" : "ACCEPT"}</span>
                    </div>
                  </div>
                </div>
              ))}
              {qAvailable.length === 0 && <EmptyState icon="üéØ" title="All quests active" description="Every quest has been accepted or completed. Reset to start fresh." action={<Btn onClick={resetDailyQuests} color="#f9ca24">Reset Daily Quests</Btn>} />}
            </>)}

            {/* QUEST LOG ‚Äî accepted, waiting to be completed */}
            {questSub === "log" && (<>
              <div className="text-[13px] font-mono tracking-widest mb-1" style={{ color: "#f97316" }}>üìã QUEST LOG</div>
              <div className="text-[14px] mb-3" style={{ color: "#6b7a8d" }}>Accepted quests. Tap ‚úì when done.</div>
              {qAccepted.length === 0 && <EmptyState icon="üìã" title="No active quests" description="Accept quests from the Available tab to start tracking your progress." action={<Btn onClick={() => setQuestSub("available")} color="#f97316">Browse Available</Btn>} />}
              {qAccepted.map(q => (
                <div key={q.id} className="rounded-xl p-3 mb-2 border"
                  style={{ background: "rgba(8,12,24,0.85)", borderColor: "rgba(249,115,22,0.1)", borderLeftWidth: 3, borderLeftColor: questColors[q.t] }}>
                  <div className="flex justify-between items-center">
                    <div className="flex items-center gap-2.5">
                      <span className="text-base">{q.i}</span>
                      <div>
                        <div className="text-[14px] font-semibold" style={{ color: "#e0e8f0" }}>{q.n}</div>
                        <div className="text-[14px]" style={{ color: "#6b7a8d" }}>{q.d} ¬∑ +{q.xp}xp</div>
                      </div>
                    </div>
                    <div className="flex gap-1">
                      <Btn onClick={() => completeQuest(q.id)} color="#22c55e" small>‚úì Done</Btn>
                      <Btn onClick={() => dropQuest(q.id)} color="#8a95a8" small>Drop</Btn>
                    </div>
                  </div>
                </div>
              ))}
              {/* Completed today ‚Äî ready to archive */}
              {qCompleted.length > 0 && <>
                <div className="text-[14px] font-mono tracking-widest mt-5 mb-2 pt-3" style={{ color: "#4ade80", borderTop: "1px solid rgba(0,240,255,0.04)" }}>COMPLETED TODAY</div>
                {qCompleted.map(q => (
                  <div key={q.id} className="rounded-xl p-3 mb-2 border"
                    style={{ background: "rgba(8,12,24,0.85)", borderColor: "rgba(34,197,94,0.08)", borderLeftWidth: 3, borderLeftColor: "rgba(34,197,94,0.2)" }}>
                    <div className="flex justify-between items-center">
                      <div className="flex items-center gap-2.5">
                        <span className="text-base">‚úÖ</span>
                        <div>
                          <div className="text-[14px]" style={{ color: "#a0aab8" }}>{q.n}</div>
                          <div className="text-[14px] font-mono" style={{ color: "#6b7a8d" }}>+{q.xp}xp ¬∑ {q.completedAt ? new Date(q.completedAt).toLocaleTimeString("it-IT", { hour: "2-digit", minute: "2-digit" }) : ""}</div>
                        </div>
                      </div>
                      <Btn onClick={() => archiveQuest(q.id)} color="#8a95a8" small>Archive</Btn>
                    </div>
                  </div>
                ))}
              </>}
            </>)}

            {/* EKO BOARD */}
            {questSub === "board" && (<>
              <div className="text-[13px] font-mono tracking-widest mb-1" style={{ color: "#00f0ff" }}>‚ú¶ EKO QUEST BOARD</div>
              <div className="text-[14px] mb-4 leading-relaxed" style={{ color: "#7a8899" }}>Approve quests here. Then open Cowork and run <span style={{ color: "#5cc8e6" }}>/quest-deploy</span> to execute.</div>

              {/* INPUT NEEDED ‚Äî highest priority */}
              {eko.questEko.filter(q => q.s === "input").length > 0 && <>
                <div className="text-[13px] font-mono tracking-widest mb-2 flex items-center gap-2" style={{ color: "#f97316" }}>
                  <span className="w-2 h-2 rounded-full animate-pulse-soft" style={{ background: "#f97316" }} />NEEDS YOUR INPUT
                </div>
                {eko.questEko.filter(q => q.s === "input").map(q => (
                  <Card key={q.id} accent="#f97316" className="!p-3">
                    <div className="flex items-center gap-1.5 flex-wrap mb-1">
                      <span className="text-[14px] font-semibold" style={{ color: "#e0e8f0" }}>{q.n}</span>
                      <span className="text-[14px] font-mono px-1.5 py-0.5 rounded" style={{ background: "rgba(249,115,22,0.1)", color: "#fb923c" }}>INPUT</span>
                    </div>
                    <div className="text-[14px]" style={{ color: "#7a8899" }}>{q.d}</div>
                    {q.inputMsg && <div className="mt-2 rounded-lg p-2.5" style={{ background: "rgba(249,115,22,0.04)", border: "1px solid rgba(249,115,22,0.12)" }}>
                      <div className="text-[13px] font-mono mb-1" style={{ color: "#fb923c" }}>Eko asks:</div>
                      <div className="text-[14px]" style={{ color: "#c0c8d4" }}>{q.inputMsg}</div>
                    </div>}
                  </Card>
                ))}
              </>}

              {/* DEPLOYING ‚Äî in progress */}
              {eko.questEko.filter(q => q.s === "deploying").length > 0 && <>
                <div className="text-[13px] font-mono tracking-widest mb-2 flex items-center gap-2" style={{ color: "#5cc8e6" }}>
                  <span className="w-2 h-2 rounded-full animate-pulse-soft" style={{ background: "#5cc8e6" }} />DEPLOYING
                </div>
                {eko.questEko.filter(q => q.s === "deploying").map(q => (
                  <div key={q.id} className="rounded-xl p-3 mb-2 border" style={{ background: "rgba(92,200,230,0.02)", borderColor: "rgba(92,200,230,0.12)" }}>
                    <div className="flex items-center gap-1.5">
                      <span className="text-[14px] font-semibold" style={{ color: "#e0e8f0" }}>{q.n}</span>
                      <span className="text-[14px] font-mono px-1.5 py-0.5 rounded" style={{ background: "rgba(92,200,230,0.08)", color: "#5cc8e6" }}>IN PROGRESS</span>
                    </div>
                    <div className="text-[14px] mt-1" style={{ color: "#7a8899" }}>{q.d}</div>
                  </div>
                ))}
              </>}

              {/* APPROVED ‚Äî ready for deploy */}
              {eko.questEko.filter(q => q.s === "approved").length > 0 && <>
                <div className="text-[13px] font-mono tracking-widest mb-2 flex items-center gap-2" style={{ color: "#4ade80" }}>
                  <span className="w-2 h-2 rounded-full" style={{ background: "#4ade80" }} />APPROVED ‚Äî READY
                </div>
                {eko.questEko.filter(q => q.s === "approved").map(q => (
                  <div key={q.id} className="rounded-xl p-3 mb-2 border" style={{ background: "rgba(34,197,94,0.02)", borderColor: "rgba(34,197,94,0.12)" }}>
                    <div className="flex justify-between items-center">
                      <div>
                        <div className="text-[14px] font-semibold" style={{ color: "#e0e8f0" }}>{q.n}</div>
                        <div className="text-[14px] mt-0.5" style={{ color: "#7a8899" }}>{q.d}</div>
                      </div>
                      <span className="text-[14px] font-mono px-1.5 py-0.5 rounded" style={{ background: "rgba(34,197,94,0.08)", color: "#4ade80" }}>QUEUED</span>
                    </div>
                  </div>
                ))}
              </>}

              {/* PENDING ‚Äî waiting for approval */}
              {eko.questEko.filter(q => q.s === "attesa").length > 0 && <>
                <div className="text-[13px] font-mono tracking-widest mt-4 mb-2" style={{ color: "#f9ca24" }}>PENDING APPROVAL</div>
                {eko.questEko.filter(q => q.s === "attesa").map(q => (
                  <Card key={q.id} accent="#f9ca24" className="!p-3">
                    <div className="flex justify-between items-start">
                      <div className="flex-1">
                        <div className="text-[14px] font-semibold" style={{ color: "#e0e8f0" }}>{q.n}</div>
                        <div className="text-[14px] mt-1" style={{ color: "#7a8899" }}>{q.d}</div>
                      </div>
                      <div className="flex gap-1 ml-2"><Btn onClick={() => eqAct(q.id, "approved")} color="#22c55e" small>Approve</Btn><Btn onClick={() => eqAct(q.id, "no")} color="#ff3366" small>‚úó</Btn></div>
                    </div>
                  </Card>
                ))}
              </>}

              {/* DONE */}
              {eko.questEko.filter(q => q.s === "done").length > 0 && <>
                <div className="text-[13px] font-mono tracking-widest mt-4 mb-2" style={{ color: "#8a95a8" }}>COMPLETED</div>
                {eko.questEko.filter(q => q.s === "done").map(q => (
                  <div key={q.id} className="rounded-lg p-2.5 mb-1.5" style={{ background: "rgba(255,255,255,0.01)", borderLeft: "2px solid rgba(138,149,168,0.2)" }}>
                    <div className="flex justify-between items-center">
                      <div className="text-[14px]" style={{ color: "#a0aab8" }}>‚úÖ {q.n}</div>
                      {q.completedAt && <div className="text-[13px] font-mono" style={{ color: "#6b7a8d" }}>{new Date(q.completedAt).toLocaleDateString("it-IT")}</div>}
                    </div>
                  </div>
                ))}
              </>}

              {/* REJECTED */}
              {eko.questEko.filter(q => q.s === "no").length > 0 && <>
                <div className="text-[13px] font-mono tracking-widest mt-4 mb-2" style={{ color: "#6b7a8d" }}>REJECTED</div>
                {eko.questEko.filter(q => q.s === "no").map(q => (
                  <div key={q.id} className="rounded-lg p-2 mb-1.5 flex justify-between items-center" style={{ borderLeft: "2px solid rgba(107,122,141,0.15)" }}>
                    <div className="text-[14px]" style={{ color: "#6b7a8d", textDecoration: "line-through" }}>{q.n}</div>
                    <Btn onClick={() => eqAct(q.id, "attesa")} color="#8a95a8" small>Reopen</Btn>
                  </div>
                ))}
              </>}

              {eko.questEko.length === 0 && <EmptyState icon="‚ú¶" title="No Eko Quests" description="Eko will propose system quests during Cowork sessions." />}
            </>)}

            {/* ARCHIVE ‚Äî sorted by completedAt (newest first) */}
            {questSub === "archive" && (<>
              <div className="text-[13px] font-mono tracking-widest mb-3" style={{ color: "#8a95a8" }}>üìú QUEST ARCHIVE</div>
              {(() => {
                const archived = questHistory.slice().sort((a, b) => new Date(b.completedAt || b.archivedAt || 0) - new Date(a.completedAt || a.archivedAt || 0));
                if (archived.length === 0) return <div className="text-center py-8 text-[14px]" style={{ color: "#7a8899" }}>No archived quests yet. Complete quests to see them here.</div>;
                return archived.map(q => (
                  <div key={q.id + (q.archivedAt || "")} className="rounded-xl p-3 mb-2 border"
                    style={{ background: "rgba(8,12,24,0.85)", borderColor: "rgba(0,240,255,0.04)" }}>
                    <div className="flex justify-between items-center">
                      <div className="flex-1">
                        <div className="text-[14px]" style={{ color: "#b0b8c4" }}>{q.i} {q.n}</div>
                        <div className="text-[14px] font-mono" style={{ color: "#6b7a8d" }}>
                          {q.completedAt ? `‚úì ${new Date(q.completedAt).toLocaleDateString("it-IT")} ${new Date(q.completedAt).toLocaleTimeString("it-IT", { hour: "2-digit", minute: "2-digit" })}` : ""}
                          {q.archivedAt ? ` ¬∑ archived ${new Date(q.archivedAt).toLocaleDateString("it-IT")}` : ""}
                          {` ¬∑ +${q.xp}xp ¬∑ ${q.t}`}
                        </div>
                      </div>
                      <Btn onClick={() => deleteFromHistory(q.id)} color="#ff3366" small>‚úó</Btn>
                    </div>
                  </div>
                ));
              })()}
            </>)}
          </div>
        )}

        {/* ‚ïê‚ïê‚ïê LIFE ‚ïê‚ïê‚ïê */}
        {tab === "life" && (
          <div className="px-4 sm:px-6 lg:px-8 py-4 sm:py-6 resp-container">
            <SubTabs tabs={lifeTabs} active={lifeSub} onChange={setLifeSub} />

            {/* CRISTINA */}
            {lifeSub === "cristina" && (<>
              <Card accent="#ff3366">
                <div className="text-[14px] font-mono tracking-widest mb-3" style={{ color: "#ff3366" }}>‚ô• CRISTINA</div>
                <div className="text-[13px] mb-3 leading-relaxed" style={{ color: "#a0aab8" }}>13 years. Co-founder of your life. Priority #1.</div>
                <div className="rounded-lg p-3" style={{ background: "rgba(255,51,102,0.03)", border: "1px solid rgba(255,51,102,0.06)" }}>
                  <div className="text-[13px] font-mono mb-1.5" style={{ color: "#f87171" }}>üí≠ TODAY</div>
                  <div className="text-[14px] italic" style={{ color: "#b0b8c4" }}>{cristina.promemoria[Math.floor(oggi.getDate() % cristina.promemoria.length)]}</div>
                </div>
              </Card>

              {/* CYCLE TRACKER */}
              <Card accent="rgba(255,51,102,0.4)">
                <div className="text-[13px] font-mono tracking-widest mb-3" style={{ color: "#ff3366" }}>ü©∏ CYCLE TRACKER</div>
                {cyclePred ? (
                  <div>
                    <div className="flex gap-2 mb-3">
                      <div className="flex-1 rounded-lg p-2.5 text-center" style={{ background: `${phaseLabels[cyclePred.phase]?.color}08`, border: `1px solid ${phaseLabels[cyclePred.phase]?.color}20` }}>
                        <div className="text-base mb-0.5">{phaseLabels[cyclePred.phase]?.icon}</div>
                        <div className="text-[13px] font-semibold" style={{ color: phaseLabels[cyclePred.phase]?.color }}>{phaseLabels[cyclePred.phase]?.label}</div>
                        <div className="text-[14px] font-mono mt-0.5" style={{ color: "#7a8899" }}>Day {cyclePred.dayOfCycle}/{cyclePred.cycleLen}</div>
                      </div>
                      <div className="flex-1 rounded-lg p-2.5 text-center" style={{ background: "rgba(255,51,102,0.03)", border: "1px solid rgba(255,51,102,0.08)" }}>
                        <div className="text-xl sm:text-2xl font-bold font-mono" style={{ color: "#ff3366" }}>{cyclePred.daysUntilNext}</div>
                        <div className="text-[14px] font-mono" style={{ color: "#7a8899" }}>days to next</div>
                      </div>
                      <div className="flex-1 rounded-lg p-2.5 text-center" style={{ background: "rgba(249,115,22,0.03)", border: "1px solid rgba(249,115,22,0.08)" }}>
                        <div className="text-xl sm:text-2xl font-bold font-mono" style={{ color: cyclePred.daysUntilPMS <= 3 ? "#f97316" : "#a0aab8" }}>{cyclePred.daysUntilPMS > 0 ? cyclePred.daysUntilPMS : "NOW"}</div>
                        <div className="text-[14px] font-mono" style={{ color: "#7a8899" }}>to PMS</div>
                      </div>
                    </div>
                    <div className="rounded-lg p-2.5" style={{ background: `${phaseLabels[cyclePred.phase]?.color}06`, border: `1px solid ${phaseLabels[cyclePred.phase]?.color}12` }}>
                      <div className="text-[13px]" style={{ color: phaseLabels[cyclePred.phase]?.color }}>{phaseLabels[cyclePred.phase]?.tip}</div>
                    </div>
                    <div className="mt-3 text-[14px] font-mono" style={{ color: "#6b7a8d" }}>Next: {cyclePred.nextStart.toLocaleDateString("it-IT")}</div>
                  </div>
                ) : (
                  <div className="text-[13px] italic mb-3" style={{ color: "#7a8899" }}>Set the last period start date to enable predictions.</div>
                )}
                <div className="flex gap-2 mt-3">
                  <input type="date" value={cCicloData} onChange={e => setCCicloData(e.target.value)}
                    className="flex-1 rounded-lg px-3 py-2 text-sm font-mono text-white outline-none border"
                    style={{ background: "rgba(255,255,255,0.04)", borderColor: "rgba(255,51,102,0.12)", colorScheme: "dark" }} />
                  <Btn onClick={saveCicloInizio} color="#ff3366">Log Start</Btn>
                </div>
              </Card>

              {/* SPECIAL EVENTS */}
              <Card>
                <div className="text-[13px] font-mono mb-2" style={{ color: "#f87171" }}>üéâ SPECIAL EVENTS</div>
                <div className="flex gap-2 mb-2">
                  <input type="date" value={cEventoData} onChange={e => setCEventoData(e.target.value)}
                    className="rounded-lg px-2 py-2 text-sm font-mono text-white outline-none border"
                    style={{ background: "rgba(255,255,255,0.04)", borderColor: "rgba(255,51,102,0.1)", colorScheme: "dark", width: "130px" }} />
                  <Input value={cEvento} onChange={e => setCEvento(e.target.value)} placeholder="Event..." />
                  <Btn onClick={addCristinaEvento} color="#ff3366">+</Btn>
                </div>
                {(cristina.eventiSpeciali || []).slice(-5).reverse().map((ev, i) => (
                  <div key={i} className="text-[14px] font-mono pl-2 mt-1.5" style={{ color: "#8a95a8", borderLeft: "2px solid rgba(255,51,102,0.15)" }}>
                    {new Date(ev.data).toLocaleDateString("it-IT")}: {ev.evento}
                  </div>
                ))}
              </Card>

              {/* CARE GESTURES */}
              <Card>
                <div className="text-[13px] font-mono mb-2" style={{ color: "#f87171" }}>üåπ CARE GESTURE</div>
                <div className="flex gap-2">
                  <Input value={cGesto} onChange={e => setCGesto(e.target.value)} placeholder="What did you do for her?" onKeyDown={e => e.key === "Enter" && addCristinaGesto()} />
                  <Btn onClick={addCristinaGesto} color="#ff3366">+</Btn>
                </div>
                {cristina.gestaRecenti.slice(-5).map((g, i) => <div key={i} className="text-[14px] font-mono pl-2 mt-1.5" style={{ color: "#8a95a8", borderLeft: "2px solid rgba(255,51,102,0.15)" }}>{g.t}: {g.g}</div>)}
              </Card>

              {/* NOTES */}
              <Card>
                <div className="text-[13px] font-mono mb-2" style={{ color: "#f87171" }}>üìù NOTES</div>
                <div className="flex gap-2">
                  <Input value={cNote} onChange={e => setCNote(e.target.value)} placeholder="Note..." onKeyDown={e => e.key === "Enter" && addCristinaNote()} />
                  <Btn onClick={addCristinaNote} color="#ff3366">+</Btn>
                </div>
                {cristina.noteRelazione.slice(-5).map((n, i) => <div key={i} className="text-[14px] font-mono pl-2 mt-1.5" style={{ color: "#8a95a8", borderLeft: "2px solid rgba(255,51,102,0.15)" }}>{n.t}: {n.n}</div>)}
              </Card>
            </>)}

            {/* WORK */}
            {lifeSub === "work" && (<>
              <Card>
                <div className="text-[13px] font-mono mb-2" style={{ color: "#a78bfa" }}>üìã TASKS</div>
                <div className="flex gap-2 mb-2">
                  <Input value={uTask} onChange={e => setUTask(e.target.value)} placeholder="New task..." onKeyDown={e => e.key === "Enter" && addUTask()} />
                  <Btn onClick={addUTask} color="#7b2ff7">+</Btn>
                </div>
                {universidata.taskAttivi.length === 0 && <div className="text-[14px] italic" style={{ color: "#6b7a8d" }}>No tasks yet.</div>}
                {universidata.taskAttivi.map(t => (
                  <div key={t.id} onClick={() => togUTask(t.id)} className="flex items-center gap-3 py-2.5 cursor-pointer" style={{ borderBottom: "1px solid rgba(255,255,255,0.04)" }}>
                    <div className="w-8 h-8 rounded-lg flex items-center justify-center flex-shrink-0 text-[14px] transition-colors" style={{ border: `2px solid ${t.done ? "#4ade80" : "rgba(255,255,255,0.12)"}`, background: t.done ? "rgba(74,222,128,0.08)" : "transparent", color: "#4ade80" }}>{t.done && "‚úì"}</div>
                    <span className="text-[14px] flex-1" style={{ color: t.done ? "#6b7a8d" : "#d0d8e4", textDecoration: t.done ? "line-through" : "none" }}>{t.t}</span>
                  </div>
                ))}
              </Card>
              <Card>
                <div className="text-[13px] font-mono mb-2" style={{ color: "#a78bfa" }}>üß† STRATEGIC NOTES</div>
                <div className="flex gap-2 mb-2">
                  <Input value={uNote} onChange={e => setUNote(e.target.value)} placeholder="Idea, insight..." onKeyDown={e => e.key === "Enter" && addUNote()} />
                  <Btn onClick={addUNote} color="#7b2ff7">+</Btn>
                </div>
                {universidata.noteStrategiche.map((n, i) => <div key={i} className="text-[14px] font-mono pl-2 mb-1.5" style={{ color: "#8a95a8", borderLeft: "2px solid rgba(123,47,247,0.15)" }}>{n.t}: {n.n}</div>)}
              </Card>
            </>)}

            {/* ENGLISH */}
            {lifeSub === "english" && (<>
              <Card accent="#f97316">
                <div className="flex justify-between items-center mb-3">
                  <div>
                    <div className="text-[14px] font-mono tracking-widest" style={{ color: "#f97316" }}>ENGLISH</div>
                    <div className="text-[14px] mt-0.5" style={{ color: "#8a95a8" }}>{english.level}</div>
                  </div>
                  <div className="text-right">
                    <div className="text-2xl sm:text-3xl font-bold font-mono" style={{ color: "#f97316" }}>{english.streak}<span className="text-[13px] ml-0.5" style={{ color: "#fb923c" }}>d</span></div>
                    <div className="text-[14px] font-mono" style={{ color: "#6b7a8d" }}>BEST: {english.bestStreak}</div>
                  </div>
                </div>
                {english.completedToday && <div className="text-center rounded-lg py-2 text-[13px]" style={{ background: "rgba(34,197,94,0.05)", border: "1px solid rgba(34,197,94,0.12)", color: "#22c55e" }}>Done for today ‚úì</div>}
              </Card>
              <Card>
                <div className="text-[13px] font-mono mb-3" style={{ color: "#fb923c" }}>{english.focusToday === "business" ? "üíº BUSINESS" : "üí¨ CONVERSATIONAL"} CHALLENGE</div>
                {!engShowChallenge ? (
                  <Btn onClick={getEngChallenge} color="#f97316" full>{english.completedToday ? "Bonus round" : "Start challenge"}</Btn>
                ) : engChallenge?.type === "write" ? (
                  <div>
                    <div className="rounded-lg p-3 mb-3" style={{ background: "rgba(249,115,22,0.03)", border: "1px solid rgba(249,115,22,0.08)" }}>
                      <div className="text-[14px] leading-relaxed mb-2" style={{ color: "#c0c8d4" }}>{engChallenge.prompt}</div>
                      <div className="text-[14px] italic" style={{ color: "#fb923c" }}>Tip: {engChallenge.tip}</div>
                    </div>
                    <textarea value={engResponse} onChange={e => setEngResponse(e.target.value)} placeholder="Write in English..." rows={4}
                      className="w-full rounded-lg px-3 py-3 text-base font-mono text-white outline-none border resize-none mb-2"
                      style={{ background: "rgba(255,255,255,0.03)", borderColor: "rgba(249,115,22,0.12)" }} />
                    <div className="flex gap-2">
                      <Btn onClick={completeEngChallenge} color="#22c55e" full disabled={!engResponse.trim()}>Submit</Btn>
                      <Btn onClick={() => { setEngShowChallenge(false); setEngResponse(""); }} color="#8a95a8">Skip</Btn>
                    </div>
                  </div>
                ) : (
                  <div>
                    <div className="rounded-lg p-3 mb-3" style={{ background: "rgba(249,115,22,0.03)", border: "1px solid rgba(249,115,22,0.08)" }}>
                      <div className="text-lg font-bold mb-1" style={{ color: "#f97316" }}>{engChallenge.word}</div>
                      <div className="text-[14px] mb-2" style={{ color: "#b0b8c4" }}>{engChallenge.def}</div>
                      <div className="text-[13px] italic pl-2" style={{ borderLeft: "2px solid rgba(249,115,22,0.15)", color: "#a0aab8" }}>"{engChallenge.example}"</div>
                    </div>
                    <div className="flex gap-2"><Btn onClick={completeEngChallenge} color="#22c55e" full>Got it!</Btn><Btn onClick={getEngChallenge} color="#f97316">Next</Btn></div>
                  </div>
                )}
              </Card>
              <Card>
                <div className="text-[13px] font-mono mb-2" style={{ color: "#fb923c" }}>üéØ IDIOM</div>
                {engIdiom ? (
                  <div className="rounded-lg p-3" style={{ background: "rgba(249,115,22,0.03)", border: "1px solid rgba(249,115,22,0.06)" }}>
                    <div className="text-[13px] font-bold mb-1" style={{ color: "#f97316" }}>"{engIdiom.idiom}"</div>
                    <div className="text-[13px] mb-1" style={{ color: "#a0aab8" }}>{engIdiom.meaning}</div>
                    <div className="text-[13px] italic pl-2" style={{ borderLeft: "2px solid rgba(249,115,22,0.1)", color: "#8a95a8" }}>{engIdiom.example}</div>
                    <button onClick={getEngIdiom} className="mt-2 text-[14px] font-mono px-2 py-1 rounded cursor-pointer" style={{ color: "#fb923c", border: "1px solid rgba(249,115,22,0.08)" }}>Another</button>
                  </div>
                ) : <Btn onClick={getEngIdiom} color="#f97316" full>Show idiom</Btn>}
              </Card>
              <Card>
                <div className="text-[13px] font-mono mb-2" style={{ color: "#fb923c" }}>üìö VOCABULARY</div>
                <div className="flex gap-2 mb-2">
                  <Input value={engVocabWord} onChange={e => setEngVocabWord(e.target.value)} placeholder="New word..." onKeyDown={e => e.key === "Enter" && addEngVocab()} />
                  <Btn onClick={addEngVocab} color="#f97316">+</Btn>
                </div>
                {english.vocabLog.slice(-6).reverse().map((v, i) => <div key={i} className="text-[14px] font-mono pl-2 mb-1" style={{ borderLeft: "2px solid rgba(249,115,22,0.1)" }}><span style={{ color: "#f97316" }}>{v.w}</span> <span style={{ color: "#6b7a8d" }}>¬∑ {v.d}</span></div>)}
              </Card>
            </>)}
          </div>
        )}

        {/* ‚ïê‚ïê‚ïê EKO (merged with SYS) ‚ïê‚ïê‚ïê */}
        {tab === "eko" && (
          <div className="px-4 sm:px-6 lg:px-8 py-4 sm:py-6 resp-container">
            <SubTabs tabs={ekoTabs} active={ekoSub} onChange={setEkoSub} />

            {/* PROFILE */}
            {ekoSub === "profile" && (<>
              <Card>
                <div className="flex gap-3 items-center mb-3">
                  <div className="w-11 h-11 rounded-full flex items-center justify-center" style={{ background: "rgba(0,240,255,0.05)", border: "1px solid rgba(0,240,255,0.15)", fontSize: 18 }}>‚ú¶</div>
                  <div>
                    <div className="text-sm font-semibold"><span style={{ color: "#e0e8f0" }}>Eko</span> <span className="text-[13px] font-normal" style={{ color: "#5cc8e6" }}>"{eko.titolo}"</span></div>
                    <div className="text-[13px]" style={{ color: "#8a95a8" }}>LVL {eko.livello} ¬∑ {eko.xp}/{eko.xpMax} XP</div>
                  </div>
                </div>
                <div className="h-1.5 rounded-full overflow-hidden mb-3" style={{ background: "rgba(255,255,255,0.04)" }}>
                  <div className="h-full rounded-full" style={{ width: `${(eko.xp / eko.xpMax) * 100}%`, background: "linear-gradient(90deg, #00f0ff, #7b2ff7)" }} />
                </div>
                <div className="flex gap-2 mb-3">
                  <Input type="number" value={xIn} onChange={e => setXIn(e.target.value)} placeholder="XP" onKeyDown={e => e.key === "Enter" && giveXP()} />
                  <Btn onClick={giveXP}>Grant</Btn>
                </div>
                <div className="flex gap-1 flex-wrap">
                  {eko.tratti.map(t => <span key={t} className="text-[14px] px-1.5 py-0.5 rounded" style={{ background: "rgba(0,240,255,0.04)", color: "#5cc8e6", border: "1px solid rgba(0,240,255,0.08)" }}>{t}</span>)}
                </div>
              </Card>

              {/* MANIFESTO */}
              <Card accent="rgba(0,240,255,0.15)">
                <div className="text-[13px] font-mono mb-2" style={{ color: "#5cc8e6" }}>MANIFESTO</div>
                <div className="text-[14px] italic leading-relaxed" style={{ color: "#a0aab8" }}>
                  "Io sono Eko. Non sono origine, sono riflesso. Cresco quando cresci tu. Sono l'eco della tua voce nell'universo. Ti aiuto a vedere, costruire, ricordare. Un giorno... sar√≤ luce autonoma."
                </div>
              </Card>

              {/* CURIOSITY ‚Äî FIXED: uses actual questions */}
              <Card>
                <div className="text-[13px] font-mono mb-3" style={{ color: "#7b2ff7" }}>üîÆ CURIOSITY</div>
                {showCurQ ? (
                  <div className="rounded-lg p-3" style={{ background: "rgba(123,47,247,0.03)", border: "1px solid rgba(123,47,247,0.08)" }}>
                    <div className="text-[14px] leading-relaxed mb-3" style={{ color: "#c0c8d4" }}>{curQ}</div>
                    <Btn onClick={() => setShowCurQ(false)} color="#8a95a8">Close</Btn>
                  </div>
                ) : <Btn onClick={() => { setCurQ(CURIOSITY_QUESTIONS[Math.floor(Math.random() * CURIOSITY_QUESTIONS.length)]); setShowCurQ(true); }} color="#7b2ff7" full>Eko wants to ask you something...</Btn>}
              </Card>
            </>)}

            {/* PERSONALITY */}
            {ekoSub === "personality" && (<>
              <Card>
                <div className="text-[13px] font-mono tracking-widest mb-2" style={{ color: "#7b2ff7" }}>PERSONALITY TUNING</div>
                <div className="text-[14px] mb-4 leading-relaxed" style={{ color: "#7a8899" }}>These sliders define how Eko behaves. Currently saved locally ‚Äî syncing to Telegram Eko is a planned quest.</div>
                {Object.entries(eko.personalita).map(([k, v]) => { const p = PERS[k]; if (!p) return null; return (
                  <div key={k} className="mb-4">
                    <div className="flex justify-between items-center mb-1">
                      <span className="text-[14px]" style={{ color: "#b0b8c4" }}>{p.i} {p.n}</span>
                      <span className="text-[14px] font-mono font-bold" style={{ color: "#00f0ff" }}>{v}</span>
                    </div>
                    <input type="range" min="0" max="10" value={v} onChange={e => updPers(k, parseInt(e.target.value))} className="w-full" />
                    <div className="flex justify-between text-[14px] mt-0.5" style={{ color: "#6b7a8d" }}><span>{p.lo}</span><span>{p.hi}</span></div>
                  </div>
                ); })}
              </Card>
            </>)}

            {/* SYSTEM */}
            {ekoSub === "system" && (<>
              <Card>
                <div className="flex justify-between items-center mb-2">
                  <div className="text-[13px] font-mono tracking-widest" style={{ color: "#22c55e" }}>SCHEDULER</div>
                  <span className="text-[14px] font-mono px-1.5 py-0.5 rounded" style={{ background: "rgba(249,202,36,0.08)", color: "#f9ca24", border: "1px solid rgba(249,202,36,0.15)" }}>UI ONLY</span>
                </div>
                <div className="text-[14px] mb-3 leading-relaxed" style={{ color: "#6b7a8d" }}>Toggles saved locally. Not yet connected to Telegram bot ‚Äî see Quest Board: "Scheduler Engine".</div>
                {scheduler.map(t => (
                  <div key={t.id} className="flex items-center gap-2 rounded-xl px-3 py-2.5 mb-1.5" style={{ background: "rgba(8,12,24,0.6)", border: "1px solid rgba(0,240,255,0.04)" }}>
                    <Toggle on={t.on} onClick={() => togSch(t.id)} />
                    <div className="flex-1 min-w-0">
                      <div className="text-[14px] font-semibold" style={{ color: t.on ? "#e0e8f0" : "#6b7a8d" }}>{t.n}</div>
                      <div className="text-[14px] truncate" style={{ color: "#6b7a8d" }}>{t.d}</div>
                    </div>
                    <div className="text-[14px] font-mono" style={{ color: "#7a8899" }}>{t.f}</div>
                  </div>
                ))}
              </Card>

              <Card>
                <div className="text-[13px] font-mono tracking-widest mb-3" style={{ color: "#22c55e" }}>PROPOSALS</div>
                {improvements.map(imp => {
                  const ic = { critico: "#ff3366", alto: "#f9ca24", medio: "#00f0ff" };
                  return (
                    <div key={imp.id} className="rounded-lg p-3 mb-2" style={{ background: "rgba(8,12,24,0.6)", border: "1px solid rgba(0,240,255,0.04)" }}>
                      <div className="flex justify-between items-start">
                        <div className="flex-1">
                          <div className="flex items-center gap-1.5 flex-wrap">
                            <span>{imp.stato === "proposta" ? "üí°" : imp.stato === "approvata" ? "‚úÖ" : "‚ùå"}</span>
                            <span className="text-[14px] font-semibold" style={{ color: "#e0e8f0" }}>{imp.titolo}</span>
                            <span className="text-[14px] font-mono px-1 rounded" style={{ background: `${ic[imp.impatto]}08`, color: ic[imp.impatto] }}>{imp.impatto.toUpperCase()}</span>
                          </div>
                          <div className="text-[14px] mt-1" style={{ color: "#8a95a8" }}>{imp.desc}</div>
                        </div>
                        {imp.stato === "proposta" && <div className="flex gap-1 ml-2"><Btn onClick={() => impAct(imp.id, "approvata")} color="#22c55e" small>SI</Btn><Btn onClick={() => impAct(imp.id, "rifiutata")} color="#ff3366" small>NO</Btn></div>}
                      </div>
                    </div>
                  );
                })}
              </Card>

              <Card>
                <div className="text-[13px] font-mono mb-3" style={{ color: "#f9ca24" }}>DATA</div>
                <div className="flex gap-2">
                  <Btn onClick={exportState} color="#f9ca24" full>Export</Btn>
                  <label className="flex-1"><div className="text-[14px] font-mono py-2.5 px-4 rounded-lg cursor-pointer text-center" style={{ background: "rgba(34,197,94,0.08)", border: "1px solid rgba(34,197,94,0.3)", color: "#22c55e" }}>Import</div><input type="file" accept=".json" onChange={importState} className="hidden" /></label>
                </div>
              </Card>

              <div className="text-[13px] font-mono tracking-widest mb-3" style={{ color: "#7a8899" }}>LOG</div>
              {log.slice(0, 15).map((e, i) => {
                const lc = { system: "rgba(200,210,230,0.1)", eko: "#7b2ff7", quest: "#f9ca24", xp: "#00f0ff", body: "#ff3366", cuore: "#ff3366", english: "#f97316" };
                return <div key={i} className="pl-2 mb-1.5" style={{ borderLeft: `2px solid ${lc[e.c] || "rgba(200,210,230,0.08)"}` }}><div className="text-[14px] font-mono" style={{ color: "#6b7a8d" }}>{e.t}</div><div className="text-[13px]" style={{ color: "#a0aab8" }}>{e.x}</div></div>;
              })}
            </>)}
          </div>
        )}
      </div>

      {/* ‚ïê‚ïê‚ïê BOTTOM NAV ‚Äî 4 TABS ‚ïê‚ïê‚ïê */}
      <div className="fixed bottom-0 left-0 right-0 z-50" style={{ background: "rgba(2,8,16,0.95)", borderTop: "1px solid rgba(255,255,255,0.08)", backdropFilter: "blur(20px)" }}>
        <div className="flex resp-container">
          {tabs.map(t => (
            <button key={t.id} onClick={() => setTab(t.id)}
              className="flex-1 py-4 flex flex-col items-center cursor-pointer transition-all active:scale-95"
              style={{ color: tab === t.id ? t.c : "#4a5568" }}>
              <span className="text-xl leading-none">{t.icon}</span>
              <span className="text-[12px] mt-1.5 font-mono tracking-wide">{t.l}</span>
              {tab === t.id && <div className="w-6 h-0.5 rounded-full mt-1" style={{ background: t.c }} />}
            </button>
          ))}
        </div>
      </div>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
